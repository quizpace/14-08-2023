<!DOCTYPE html>
<html>
  <head>
    <title>Registration Form</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap"
    />
    <style>
      body {
        font-family: "Open Sans", sans-serif;
      }

      form {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px;
        border: 1px solid #ccc;
      }

      label {
        display: inline-block;
        width: 120px;
        font-weight: bold;
      }

      input[type="text"],
      input[type="email"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      input[type="checkbox"],
      input[type="radio"] {
        margin-right: 5px;
      }

      button {
        background-color: #b183ce;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        float: right;
      }

      button:hover {
        background-color: #9e8ef1;
      }

      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgb(205, 233, 249);
        padding: 55px;
        width: 600px;
        max-width: 80%;
        height: auto;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
        z-index: 999;
        border-radius: 10%;
      }

      .close {
        position: absolute;
        top: 15px;
        left: 20px;
        cursor: pointer;
        color: #830913;
      }

      .popup img {
        max-width: 100%;
        height: auto;
        display: block;
        margin-top: 10px;
      }
      #popup-content table {
        opacity: 85%;
        width: 50%;
        margin-bottom: 10px;
        border: 1.5px solid #7b58a3;
        border-radius: 3%;
      }

      #popup-content th,
      #popup-content td {
        padding: 5px;
        border: 1px solid #7f9fbe;
        border-radius: 5%;
      }

      #popup-content th {
        text-align: right;
        background-color: #b08080;
        border-radius: 7%;
      }
    </style>
  </head>
  <body>
    <div class="popup" id="popup">
      <span class="close" onclick="closePopup()">&times;</span>
      <h2>User Details</h2>
      <p id="popup-content"></p>
    </div>

    <br />
    <form action="">
      <label for="fname"><b>First Name:</b> </label>
      <input type="text" id="fname" name="fname" required autofocus />
      <br />
      <br />

      <label for="lname"><b>Last Name:</b> </label>
      &nbsp;<input type="text" id="lname" name="lname" required /> <br />
      <br />

      <label for="email"><b>Email:</b> </label
      ><input type="email" id="email" name="email" required />
      <br />
      <br />

      <label for="work"><b>Work:</b> &nbsp; </label>
      &nbsp;<input type="text" id="work" name="work" /> <br />
      <br />

      <label for="phone"><b>Phone:</b> &nbsp; </label>
      &nbsp;<input type="text" id="phone" name="phone" /> <br />
      <br />

      <label for="height"><b>Height:</b> &nbsp; </label>
      &nbsp;<input type="number" id="height" name="height" /> <br />
      <br />

      <label for="city"></label>
        <form action="">
          <div class="form-field" id="city-selection">
            <label for="city-choice">בחר עיר:</label>
            <input list="cities-data" id="city-choice" name="city-choice" />
            <datalist id="cities-data">
              <option value="">טוען רשימת ערים...</option>
            </datalist>
          <div class="form-field" id="street-selection">
            <label for="street-choice">בחר רחוב:</label>
            <input
              list="streets-data"
              id="street-choice"
              name="street-choice"
            />
            <datalist id="streets-data">
              <option value=""></option>
            </datalist>
        </form>
      </select>
      <br />
      <br />
      <label for="vegan"><b>Vegan?</b> </label>
      <input type="checkbox" id="vegan" name="vegan" />
      <br />
      <br />
      <label for="oper"><b>Operating System:</b> </label>
      <input type="radio" id="mac" name="os" value="mac" required="required" />
      <label for="mac">Mac</label>
      <input
        type="radio"
        id="windows"
        name="os"
        value="windows"
        required="required"
      />
      <label for="windows">Windows</label>
      <input
        type="radio"
        id="linux"
        name="os"
        value="linux"
        required="required"
      />
      <label for="linux">Linux</label>
      <br /><br />

      <label for="profilePic"><b>Profile Picture:</b></label>
      <input type="file" id="profilePic" name="profilePic" />
      <br /><br />
      <button type="button" onclick="submitForm()">Submit</button>
      <br /><br />
      <h8> &copy; Avi Draznin</h8>
    </form>

    <script>
      /**
       * Select a street by city in Israel
       * Cities data is from https://data.gov.il/dataset/citiesandsettelments
       * Streets data is from https://data.gov.il/dataset/321
       * API documentation https://docs.ckan.org/en/latest/maintaining/datastore.html#ckanext.datastore.logic.action.datastore_search
       */

      // REST API URL
      const api_url = "https://data.gov.il/api/3/action/datastore_search";
      // Cities endpoint
      const cities_resource_id = "5c78e9fa-c2e2-4771-93ff-7f400a12f7ba";
      // Streets endpoint
      const streets_resource_id = "a7296d1a-f8c9-4b70-96c2-6ebb4352f8e3";
      // Field names
      const city_name_key = "שם_ישוב";
      const street_name_key = "שם_רחוב";
      // dataset ids
      const cities_data_id = "cities-data";
      const streets_data_id = "streets-data";
      // input elements
      const cities_input = document.getElementById("city-choice");
      const streets_input = document.getElementById("street-choice");

      /**
       * Get data from gov data API
       * Uses Axios just because it was easy
       */
      const getData = (resource_id, q = "", limit = "100") => {
        //console.log("sending", resource_id, query);
        return axios.get(api_url, {
          params: { resource_id, q, limit },
          responseType: "json",
        });
      };

      /**
       * Parse records from data into 'option' elements,
       * use data from key 'field_name' as the option value
       */
      const parseResponse = (records = [], field_name) => {
        const parsed =
          records
            .map((record) => `<option value="${record[field_name].trim()}">`)
            .join("\n") || "";
        //console.log("parsed", field_name, parsed);
        return Promise.resolve(parsed);
      };

      /**
       * Fetch data, parse, and populate Datalist
       */
      const populateDataList = (id, resource_id, field_name, query, limit) => {
        const datalist_element = document.getElementById(id);
        if (!datalist_element) {
          console.log(
            "Datalist with id",
            id,
            "doesn't exist in the document, aborting"
          );
          return;
        }
        getData(resource_id, query, limit)
          .then((response) =>
            parseResponse(response?.data?.result?.records, field_name)
          )
          .then((html) => (datalist_element.innerHTML = html))
          .catch((error) => {
            console.log("Couldn't get list for", id, "query:", query, error);
          });
      };

      // ---- APP ----

      /**
       * Populate cities.
       * There are about 1300 cities in Israel, and the API upper limit is 32000
       * so we can safely populate the list only once.
       */
      populateDataList(
        cities_data_id,
        cities_resource_id,
        city_name_key,
        undefined,
        32000
      );

      /**
       * Populate streets
       * Update the streets list on every city name change
       * (assuming there aren't more than 32,000 streets in any city)
       */
      cities_input.addEventListener("change", (event) => {
        populateDataList(
          streets_data_id,
          streets_resource_id,
          street_name_key,
          {
            שם_ישוב: cities_input.value,
          },
          32000
        );
      });

      function submitForm() {
        const firstName = document.getElementById("fname").value;
        const lastName = document.getElementById("lname").value;
        const email = document.getElementById("email").value;
        const work = document.getElementById("work").value;
        const phone = document.getElementById("phone").value;
        const height = document.getElementById("height").value;
        const city = document.getElementById("city").value;
        const isVegan = document.getElementById("vegan").checked;
        const os = document.querySelector('input[name="os"]:checked').value;
        const profilePicInput = document.getElementById("profilePic");
        const profilePic = profilePicInput.files[0];

        const popupContent = `
<table>
  <tr>
    <td><strong>First Name:</strong></td>
    <td>${firstName}</td>
  </tr>
  <tr>
    <td><strong>Last Name:</strong></td>
    <td>${lastName}</td>
  </tr>
  <tr>
    <td><strong>Email:</strong></td>
    <td>${email}</td>
  </tr>
  <tr>
    <td><strong>Work:</strong></td>
    <td>${work}</td>
  </tr>
  <tr>
    <td><strong>Phone:</strong></td>
    <td>${phone}</td>
  </tr>
  <tr>
    <td><strong>Height:</strong></td>
    <td>${height}</td>
  </tr>
  <tr>
    <td><strong>City:</strong></td>
    <td>${city}</td>
  </tr>
  <tr>
    <td><strong>Vegan?</strong></td>
    <td>${isVegan ? "Yes" : "No"}</td>
  </tr>
  <tr>
    <td><strong>Operating System:</strong></td>
    <td>${os}</td>
  </tr>
</table>
<div style="position: absolute; top: 40px; right: 20px;">
  ${
    profilePic
      ? `<img src="${URL.createObjectURL(
          profilePic
        )}" alt="Profile Picture" style="width: 250px; height: 300px;">`
      : ""
  }
</div>
`;

        document.getElementById("popup-content").innerHTML = popupContent;
        document.getElementById("popup").style.display = "block";
      }

      function closePopup() {
        var popup = document.getElementById("popup");
        popup.style.display = "none";
      }
    </script>
  </body>
</html>
